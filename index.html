<html>
  <head>
    <meta charset="UTF-8">
    <title>Parallax Scrolling Demo</title>
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<style>
      body { background-color: #000000; }
      canvas { background-color: #222222; }
    </style>
  </head>
  <body onload="init();">
    <div align="center">
      <canvas id="game-canvas" width="1024" height="768"></canvas>
    </div>
	<script src="js/pixi.js"></script>
	<script src="js/globals.js"></script>
	<script src="js/assets.js"></script>
	<script>
	
	function init(){
		loadAssets();
	}
	
    function onAssetLoaded() {
    stage = new PIXI.Stage(0x66FF99);
	renderer = PIXI.autoDetectRenderer(
		CANVAS_WIDTH,
		CANVAS_HEIGHT,
		document.getElementById("game-canvas")
	);
	
	// Mouse support
	$(renderer.view).mousedown(function(e) {
		console.log("mousedown!");
		var parentOffset = $(this).offset();
		mouseX = e.pageX - parentOffset.left;
		mouseY = e.pageY - parentOffset.top;
		current_player_frame = 0;
		mouse_down = true;
	});
	$(renderer.view).mouseup(function(e) {
		console.log("mouseup!");
		current_player_frame = 0;
		mouse_down = false;
	});
	$(renderer.view).mouseout(function(e) {
		console.log("mouseup!");
		current_player_frame = 0;
		mouse_down = false;
	});
	$(renderer.view).mousemove(function(e) {
		var parentOffset = $(this).offset();
		mouseX = e.pageX - parentOffset.left;
		mouseY = e.pageY - parentOffset.top;
		//TODO handle crossover
	});
	
	// Touch support
	$(renderer.view).on({ 'touchstart' : function() {
		console.log("touchdown!");
	}});
	$(renderer.view).on({ 'touchend' : function() {
		console.log("touchup!");
	}});
	$(renderer.view).on({ 'touchmove' : function() {
		console.log("touchmove!");
	}});
	
		
		var backgroundTexture = PIXI.Texture.fromImage(
			"scenes/"+scene+"/background.png"
			);
		backgroundTexture = new PIXI.TilingSprite(
			backgroundTexture,
			renderer.width,
			renderer.height
			);
		backgroundTexture.position.x = 0;
		backgroundTexture.position.y = 0;
		backgroundTexture.tilePosition.x = 0;
		backgroundTexture.tilePosition.y = 0;
		stage.addChild(backgroundTexture);
		
		var farTexture = PIXI.Texture.fromImage(
			"scenes/"+scene+"/far.png"
			);
		far = new PIXI.TilingSprite(
			farTexture,
			renderer.width,
			renderer.height
			);
		far.position.x = 0;
		far.position.y = 0;
		far.tilePosition.x = 0;
		far.tilePosition.y = 0;
		stage.addChild(far);

		var midTexture = PIXI.Texture.fromImage(
			"scenes/"+scene+"/mid.png"
			);
		mid = new PIXI.TilingSprite(
			midTexture,
			renderer.width,
			renderer.height
		);
		mid.position.x = 0;
		mid.position.y = 128;
		mid.tilePosition.x = 0;
		mid.tilePosition.y = 0;
		stage.addChild(mid);
		
		addPlayer();
		
		requestAnimFrame(update);
    }
	
	function addPlayer() {
		player = PIXI.Sprite.fromImage(player_idle_frames[current_player_frame]);
		player.anchor.x = 0.5;
		player.anchor.y = 0.5;
		player.position.x = playerX;
		player.position.y = playerY;
		stage.addChild(player);
	}
	
	function update() {
		if (mouse_down) {
			var mouse_location = mouseX < (CANVAS_WIDTH/2) ? 0 : 1;
			// Move player left
			if (mouse_location == 0) {
				speed = 1;
				if (sprite_animation_counter % sprite_animation_speed == 0) {
					sprite_animation_counter = 0;
					if (current_player_frame < (player_left_frames.length-1)) {
						current_player_frame += 1;
					}
					else {
						current_player_frame = 0;
					}
					player.setTexture(PIXI.Texture.fromImage(player_left_frames[current_player_frame]));
				}
			}
			// Move player right
			else {
				speed = -1;
				if (sprite_animation_counter % sprite_animation_speed == 0) {
					sprite_animation_counter = 0;
					if (current_player_frame < (player_right_frames.length-1)) {
						current_player_frame += 1;
					}
					else {
						current_player_frame = 0;
					}
					player.setTexture(PIXI.Texture.fromImage(player_right_frames[current_player_frame]));
				}
			}
		}
		else {
			speed = 0;
			if (sprite_animation_counter % sprite_animation_speed == 0) {
				sprite_animation_counter = 0;
				if (current_player_frame < (player_idle_frames.length-1)) {
					current_player_frame += 1;
				}
				else {
					current_player_frame = 0;
				}
				player.setTexture(PIXI.Texture.fromImage(player_idle_frames[current_player_frame]));
			}
		}
		sprite_animation_counter += 1;
		far.tilePosition.x -= speed * 0.250;
		mid.tilePosition.x -= speed * 4.00;
		renderer.render(stage);
		requestAnimFrame(update);
	}
  </script>
  </body>
</html>

<html>
  <head>
    <meta charset="UTF-8">
    <title>Parallax Scrolling Demo</title>
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<style>
      body { background-color: #000000; }
      canvas { background-color: #222222; }
    </style>
  </head>
  <body onload="init();" style="-moz-user-select: none;">
    <div align="center">
      <canvas id="game-canvas" width="1024" height="768"></canvas>
    </div>
	<script src="js/howler.js"></script>
	<script src="js/pixi.js"></script>
	<script src="js/globals.js"></script>
	<script src="js/assets.js"></script>
	<script>
	document.oncontextmenu = function() { return false; };
	document.onselectstart = function() { return false; };
	
	function init(){
		loadAssets();
	}

	function createScene(scene_name) {
		backgroundTexture = PIXI.Texture.fromImage(
			"scenes/"+scene_name+"/background.png"
			);
		background = new PIXI.TilingSprite(
			backgroundTexture,
			renderer.width,
			renderer.height
			);
		if(scene_name == scenes[scene_current].name){
			background.position.x = 0;
		}else{
			background.position.x = renderer.width;
		}
		background.position.y = 0;
		background.tilePosition.x = 0;
		background.tilePosition.y = 0;
		stage.addChild(background);
		
		farTexture = PIXI.Texture.fromImage(
			"scenes/"+scene_name+"/far.png"
			);
		far = new PIXI.TilingSprite(
			farTexture,
			renderer.width,
			1200
			);
		if(scene_name == scenes[scene_current].name){
			far.position.x = 0;
		}else{
			far.position.x = renderer.width;
		}
		far.position.y = 0;
		far.tilePosition.x = 0;
		far.tilePosition.y = 0;
		stage.addChild(far);

		midTexture = PIXI.Texture.fromImage(
			"scenes/"+scene_name+"/mid.png"
			);
		mid = new PIXI.TilingSprite(
			midTexture,
			renderer.width,
			renderer.height
		);
		if(scene_name == scenes[scene_current].name){
			mid.position.x = 0;
		}else{
			mid.position.x = renderer.width;
		}
		mid.position.y = 128;
		mid.tilePosition.x = 0;
		mid.tilePosition.y = 0;
		stage.addChild(mid);

		return [background, far, mid];
	}
	
    function onAssetLoaded() {
	    stage = new PIXI.Stage(0x66FF99);
		renderer = PIXI.autoDetectRenderer(
			CANVAS_WIDTH,
			CANVAS_HEIGHT,
			document.getElementById("game-canvas")
		);

		// load the scenes
		for(i=0;i<scenes.length;i++){
			scenes[i]["scene"] = createScene(scenes[i].name);
		}
		
		// Mouse support
		$(renderer.view).mousedown(function(e) {
			console.log("mousedown!");
			var parentOffset = $(this).offset();
			mouseX = e.pageX - parentOffset.left;
			mouseY = e.pageY - parentOffset.top;
			current_player_frame = 0;
			mouse_down = true;
		});
		$(renderer.view).mouseup(function(e) {
			console.log("mouseup!");
			current_player_frame = 0;
			mouse_down = false;
		});
		$(renderer.view).mouseout(function(e) {
			console.log("mouseup!");
			current_player_frame = 0;
			mouse_down = false;
		});
		$(renderer.view).mousemove(function(e) {
			var parentOffset = $(this).offset();
			mouseX = e.pageX - parentOffset.left;
			mouseY = e.pageY - parentOffset.top;
			//TODO handle crossover
		});
		
		// Touch support
		$(renderer.view).on({ 'touchstart' : function() {
			mouse_down = true;
		}});
		$(renderer.view).on({ 'touchend' : function() {
			mouse_down = false;
		}});
		$(renderer.view).on({ 'touchmove' : function() {
			mouse_down = false;
		}});
		
		// Keyboard support
		$(document).keydown(function(e) {
			// Left
			if (e.which == 37 || e.which == 65) {
				key_down = true;
				key_direction = 0;
			}
			// Right
			else if (e.which == 39 || e.which == 68) {
				key_down = true;
				key_direction = 1;
			}
		});
		$(document).keyup(function(e) {
			if (e.which == 37 || e.which == 65 || e.which == 39 || e.which == 68) {
				key_down = false;
			}
		});
		
		addPlayer();
		
		var music = new Howl({
			urls: ['sound/music/detective_jazz.ogg'],
			autoplay: true,
			loop: true,
		}).play();
		
		requestAnimFrame(update);
    }
	
	function addPlayer() {
		player = PIXI.Sprite.fromImage(scenes[scene_current]['sprites']['player_idle_frames'][current_player_frame]);
		player.anchor.x = 0.5;
		player.anchor.y = 0.5;
		player.position.x = playerX;
		player.position.y = playerY;
		stage.addChild(player);
	}
	
	function update() {
		if (mouse_down || key_down) {
			var mouse_location = mouseX < (CANVAS_WIDTH/2) ? 0 : 1;
			//console.log("mouse_down: " + mouse_down + " mouse_location: " + mouse_location);
			//console.log("key_down: " + key_down + " key_direction: " + key_direction);
			// Move player left
			if ((mouse_down && mouse_location == 0) || (key_down && key_direction == 0) && frame_count > 0) {
				speed = -acceleration;
				if (sprite_animation_counter % sprite_animation_speed == 0) {
					sprite_animation_counter = 0;
					if (current_player_frame < (scenes[scene_current]['sprites']['player_left_frames'].length-1)) {
						current_player_frame += 1;
					}
					else {
						current_player_frame = 0;
					}
					player.setTexture(PIXI.Texture.fromImage(scenes[scene_current]['sprites']['player_left_frames'][current_player_frame]));
				}
				frame_count -= 1;
				console.log(frame_count);
			}
			// Move player right
			else if ((mouse_down && mouse_location == 1) || (key_down && key_direction == 1)) {
				speed = acceleration;
				if (sprite_animation_counter % sprite_animation_speed == 0) {
					sprite_animation_counter = 0;
					if (current_player_frame < (scenes[scene_current]['sprites']['player_right_frames'].length-1)) {
						current_player_frame += 1;
					}
					else {
						current_player_frame = 0;
					}
					player.setTexture(PIXI.Texture.fromImage(scenes[scene_current]['sprites']['player_right_frames'][current_player_frame]));
				}
				frame_count += 1;
				console.log(frame_count);
			}
		}
		else {
			speed = 0;
			if (sprite_animation_counter % sprite_animation_speed == 0) {
				sprite_animation_counter = 0;
				if (current_player_frame < (scenes[scene_current]['sprites']['player_idle_frames'].length-1)) {
					current_player_frame += 1;
				}
				else {
					current_player_frame = 0;
				}
				player.setTexture(PIXI.Texture.fromImage(scenes[scene_current]['sprites']['player_idle_frames'][current_player_frame]));
			}
		}

		sprite_animation_counter += 1;

		if(scenes[scene_current]['scene'][2].position.x <= -renderer.width){

			/* scene transition code */
			scene_current += 1;

		} else if (frame_count > scenes[scene_current]['end']){

			/* move old scene off screen */
			scenes[scene_current]['scene'][2].position.x -= speed * 4;
			scenes[scene_current]['scene'][1].position.x -= speed * 4;
			scenes[scene_current]['scene'][0].position.x -= speed * 4;

			/* and new scene in */
			scenes[scene_current+1]['scene'][2].position.x -= speed * 4;
			scenes[scene_current+1]['scene'][1].position.x -= speed * 4;
			scenes[scene_current+1]['scene'][0].position.x -= speed * 4;

		} else {

			/* scrolling */
			scenes[scene_current]['scene'][2].tilePosition.x -= speed * 4;
			scenes[scene_current]['scene'][1].tilePosition.x -= speed * 0.8;

		}
		
		renderer.render(stage);
		requestAnimFrame(update);
	}
  </script>
  </body>
</html>
